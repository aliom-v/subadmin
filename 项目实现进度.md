# 项目实施与进度文档

更新时间：2026-02-25

本文件作为当前项目的唯一实施文档，替代原规划文档。

## 1. 当前结论

- 项目已具备可用 MVP，支持登录、上游管理、手动节点、同步、固定输出、JSON 备份恢复。
- 已完成“主机 sing-box 脚本 + Docker SubAdmin”共存优化（默认不占 80/443）。
- 当前仍有若干增强项未完成（日志页、完整转换接口对齐、自动备份、回滚等）。

## 2. 项目目标对照

- ~~网页管理员后台~~
- ~~管理上游订阅源~~
- ~~管理手动节点~~
- ~~定时自动同步~~
- ~~自动生成 Clash / Sing-box 订阅~~
- ~~固定订阅 URL~~
- ~~支持备份恢复（JSON）~~
- ~~Docker Compose 一键部署~~
- ~~自动 HTTPS（Caddy，可选网关模式）~~

## 3. 核心功能模块对照

### A. 管理后台

- ~~管理员登录~~
- ~~修改密码~~
- ~~CRUD 上游订阅源~~
- ~~CRUD 手动节点~~
- ~~同步状态查看~~
- ~~手动触发同步~~
- ~~设置同步频率~~
- ~~导出 / 导入（JSON）~~
- 查看系统日志（未完成）

### B. 上游订阅同步模块

- ~~支持多个上游订阅源~~
- ~~启用/禁用~~
- ~~同步间隔（分钟）~~
- ~~定时任务自动执行~~
- ~~手动触发~~
- 去重策略（已实现基础去重）
- 覆盖策略（未完成）
- 合并策略（未完成）
- 同步失败记录日志（已实现基础状态与容器日志）

### C. 订阅输出模块

- ~~固定地址 `/clash`、`/singbox`~~
- ~~聚合启用上游 + 手动节点~~
- ~~拼接 config 字符串并输出~~
- ~~支持实时输出~~
- ~~支持缓存模式输出~~
- 调用 `sublink-worker` 官方接口完全对齐（待完善）

### D. 备份模块

- 导出 SQLite 数据库文件（未完成）
- ~~导出 JSON~~
- 自动定期备份（未完成）
- ~~手动导入恢复~~
- 保留历史版本（已实现 snapshots 记录，回滚能力未完成）

## 4. API 对照

已完成（含计划内接口）：

- ~~`POST /api/login`~~
- ~~`POST /api/logout`~~
- ~~`GET /api/me`~~
- ~~`GET /api/upstreams`~~
- ~~`POST /api/upstreams`~~
- ~~`PUT /api/upstreams/:id`~~
- ~~`DELETE /api/upstreams/:id`~~
- ~~`POST /api/upstreams/:id/sync`~~
- ~~`GET /api/nodes`~~
- ~~`POST /api/nodes`~~
- ~~`PUT /api/nodes/:id`~~
- ~~`DELETE /api/nodes/:id`~~
- ~~`GET /clash`~~
- ~~`GET /singbox`~~
- ~~`GET /api/backup/export`~~
- ~~`POST /api/backup/import`~~

已扩展（计划外增强）：

- `PUT /api/password`
- `POST /api/sync`
- `GET /api/settings`
- `PUT /api/settings`
- `GET /healthz`

## 5. 已完善优化（本轮）

- ~~支持“主机 sing-box 脚本 + Docker SubAdmin”共存部署~~
- ~~默认不抢占 80/443（Caddy 改为可选 profile）~~
- ~~API/Web 默认高位端口（18080/18081）~~
- ~~`host.docker.internal` 打通（容器访问主机服务）~~
- ~~Web 内置反代 API（不开 Caddy 也可直接使用）~~
- ~~补充共存模式部署文档~~

## 6. 运行与验收补充信息

### 6.1 推荐运行模式

- 共存模式（推荐）：`docker compose up -d --build api web sublink`
- 网关模式（可选）：`docker compose --profile gateway up -d --build`

### 6.2 本地/服务器验收清单

- `http://<host>:18081/healthz` 返回 `{"status":"ok"}`
- `POST /api/login` 可成功拿到 token
- 新增手动节点后访问 `/clash` 有输出
- 新增上游后手动同步，状态显示 `ok (...)`

### 6.3 上游地址注意

- 容器内不能用 `127.0.0.1` 或 `localhost` 访问主机服务。
- 应使用主机域名 URL，或 `host.docker.internal:<port>`。

### 6.4 手动节点含义

- 当前“手动节点”是单条 URI（如 `ss://`、`vmess://`），不是整份 `yaml/json` 配置编辑器。

## 7. 关键待办（建议优先级）

1. 对齐 `sublink-worker` 官方转换 API（去掉当前兼容 fallback 模式）。
2. 增加“原始订阅内容预览/粘贴编辑”（支持整段 URI/base64，后续再扩展 YAML/JSON 结构编辑）。
3. 增加系统日志页面与同步任务明细。
4. 增加定时自动备份与 SQLite 文件导出。
5. 增加快照回滚与多 token 访问控制。

## 8. 变更记录（Changelog）

### 2026-02-25

- 初始化项目骨架：`backend`、`web`、`docker-compose`、`caddy`。
- 完成后端 API：认证、上游 CRUD、节点 CRUD、同步、设置、订阅输出、JSON 备份导入导出。
- 完成前端管理界面：登录、上游管理、手动节点管理、系统设置、备份恢复。
- 完成容器化部署：`api/web/sublink/caddy` 多服务编排。
- 修复运行问题：Caddy 路由匹配、API 容器 SQLite 写权限、前端构建语法错误。
- 完成共存模式优化：默认高位端口、可选 Caddy profile、`host.docker.internal` 可访问主机服务、Web 内置 API 反代。
- 将项目文档统一为本文件，移除旧规划文档。

## 9. 上线检查清单（Production Checklist）

上线前建议逐项确认：

1. 修改 `.env` 中 `JWT_SECRET`、`ADMIN_PASSWORD` 为强随机值。
2. 如使用网关模式，确认 `DOMAIN`、DNS、证书签发与续期正常。
3. 如使用共存模式，确认防火墙仅开放必要端口（默认 `18081`，按需开放 `18080`）。
4. 上游订阅地址全部可从容器访问，不使用 `127.0.0.1/localhost`。
5. 至少配置一个有效上游并执行一次手动同步，检查状态为 `ok (...)`。
6. 校验固定输出：`/clash`、`/singbox` 返回内容符合预期客户端。
7. 验证管理员登录、改密、退出流程。
8. 导出一次 JSON 备份并在测试环境完成导入恢复演练。
9. 配置日志采集策略（至少保留容器日志和关键操作时间点）。
10. 制定回滚方案：保留最近可用镜像与数据目录快照。
